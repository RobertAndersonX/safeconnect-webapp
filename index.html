<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>SafeConnect ‚Äî MVP</title>
  <!-- D3: Added manifest link and theme-color -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b0f14">
  <meta http-equiv="Content-Security-Policy"
    content="
      default-src 'self';
      connect-src 'self' https://*.workers.dev data: blob:;
      img-src 'self' data: blob:;
      script-src 'self' 'unsafe-inline';
      style-src 'self' 'unsafe-inline';
      font-src 'self' data:;
      base-uri 'self';
      frame-ancestors 'self';
    ">
  <style>
    :root{
      --bg:#0b0f14; --surface:#10161d; --glass:rgba(255,255,255,.04); --line:rgba(255,255,255,.08);
      --text:#e7eef6; --muted:#9aa4b2; --accent:#5eead4; --accent-2:#7aa2ff; --danger:#ff6b6b;
      --ok:#4caf50; --warn:#ffc107; --bad:#f44336; --radius:14px; --header:60px; --nav:76px;
    }
    [data-theme="midnight"]{
      /* Stronger contrast vs Dark */
      --bg:#070a0f;            /* deeper blue-black */
      --surface:#0b1320;       /* colder surface */
      --glass:rgba(120,160,255,.10);
      --line:rgba(120,160,255,.22);
      --text:#e6efff;
      --muted:#9fb3d9;
      --accent:#58a9ff;        /* colder accent than Dark */
      --accent-2:#7aa2ff;
      --danger:#ff6b6b;
    }
    /* Midnight specific shadows */
    [data-theme="midnight"] .card{ box-shadow:0 8px 28px rgba(36,84,180,.35) }
    /* Better spacing for first row inside cards (prevents buttons from sticking) */
    .card > .row:first-child{ margin-bottom:8px }
    [data-theme="light"]{
      --bg:#f6f8fb; --surface:#ffffff; --glass:rgba(0,0,0,.03); --line:rgba(0,0,0,.08);
      --text:#0b0f14; --muted:#4c5563; --accent:#0bbf9a; --accent-2:#4b72ff; --danger:#e53935;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:linear-gradient(180deg,var(--bg),var(--surface));color:var(--text);font-family:Inter,system-ui,Roboto,Arial;transition:background .2s,color .2s}
    /* Header */
    header{height:var(--header);display:flex;align-items:center;justify-content:space-between;padding:8px 12px;position:sticky;top:0;z-index:2;background:linear-gradient(180deg,rgba(0,0,0,.06),rgba(0,0,0,.02));backdrop-filter:saturate(1.2) blur(4px);border-bottom:1px solid var(--line)}
    [data-theme="light"] header{background:linear-gradient(180deg,rgba(255,255,255,.7),rgba(255,255,255,.5))}
    .hdr-left{display:flex;gap:10px;align-items:center}
    .avatar{width:40px;height:40px;border-radius:12px;background:linear-gradient(135deg,#223,#056);display:grid;place-items:center;font-weight:700;color:#fff}
    [data-theme="light"] .avatar{background:linear-gradient(135deg,#eaefff,#cfe1ff);color:#234}
    .hdr-meta{display:flex;flex-direction:column}
    .name{font-size:15px;font-weight:700}
    .sub{font-size:12px;color:var(--muted)}
    .hdr-right{display:flex;align-items:center;gap:8px}
    .pill{padding:6px 10px;border-radius:10px;background:var(--glass);font-size:12px;border:1px solid var(--line)}
    .weather{display:flex;align-items:center;gap:6px}
    /* Viewport */
    #app{height:calc(100% - var(--header));display:flex;flex-direction:column}
    main{flex:1;overflow:auto;padding:12px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(0,0,0,.08));border:1px solid var(--line);border-radius:16px;padding:12px}
    [data-theme="light"] .card{background:linear-gradient(180deg,rgba(255,255,255,.9),rgba(255,255,255,.8))}
    .grid{display:grid;gap:10px}
    .grid.cols-2{grid-template-columns:1fr 1fr}
    @media (max-width:640px){.grid.cols-2{grid-template-columns:1fr}}
    .btn{display:inline-flex;gap:8px;align-items:center;justify-content:center;height:48px;padding:0 14px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,.02));border:1px solid var(--line);color:var(--text);cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent), rgba(94,234,212,0.12));color:#012;border:0;box-shadow:0 6px 20px rgba(5,200,180,.1)}
    .btn.danger{background:linear-gradient(90deg,var(--danger), rgba(255,107,107,.12));color:#140202;border:0}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .muted{color:var(--muted)}
    .h{font-size:16px;font-weight:800;margin:6px 0 8px}
    /* Bottom nav (readable) */
    nav{height:var(--nav);display:flex;gap:8px;padding:10px;border-top:1px solid var(--line);background:linear-gradient(180deg,transparent,rgba(0,0,0,.1));overflow-x:auto}
    nav .tab{min-width:86px;flex:1;border-radius:12px;border:1px solid var(--line);background:var(--glass);display:flex;flex-direction:column;align-items:center;justify-content:center;font-weight:600;color:var(--muted);padding:6px 8px}
    nav .tab span{font-size:11px;margin-top:2px}
    nav .tab.active{background:linear-gradient(90deg,var(--accent-2),rgba(122,162,255,.12));color:#0b1020;border:0}
    /* Screens (simple router) */
    .screen{display:none;animation:fade .18s ease}
    .screen.active{display:block}
    @keyframes fade{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
    /* List & badges */
    .list{display:flex;flex-direction:column;gap:10px}
    .tile{border:1px solid var(--line);border-radius:12px;background:var(--glass);padding:10px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:var(--glass);border:1px solid var(--line);font-size:12px}
    .badge.warn{background:rgba(255,193,7,.12);border-color:rgba(255,193,7,.25)}
    .badge.danger{background:rgba(255,107,107,.12);border-color:rgba(255,107,107,.25)}
    /* Inventory-like chips for docs */
    .chips{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .chip{aspect-ratio:1/1;border-radius:12px;border:1px dashed var(--line);display:grid;place-items:center;color:var(--muted);background:var(--glass);cursor:pointer}
    .chip.filled{border-style:solid;color:#021;background:linear-gradient(180deg,var(--accent),rgba(94,234,212,.18))}
    /* Simple map placeholder */
    .map{height:220px;border-radius:12px;border:1px solid var(--line);background:repeating-linear-gradient(45deg, #0f1720, #0f1720 10px, #0c141c 10px, #0c141c 20px);display:grid;place-items:center;color:var(--muted)}
    [data-theme="midnight"] .map{background:repeating-linear-gradient(45deg,#0a1220,#0a1220 10px,#0c1a30 10px,#0c1a30 20px)}
    [data-theme="light"] .map{background:repeating-linear-gradient(45deg, #eef2ff, #eef2ff 10px, #e7ecfe 10px, #e7ecfe 20px)}
    /* Toggle */
    .toggle{display:flex;align-items:center;gap:10px}
    .select{height:36px;border-radius:10px;border:1px solid var(--line);background:var(--glass);color:var(--text);padding:0 8px}
    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal .box{max-width:520px;width:100%;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(0,0,0,.25));border:1px solid var(--line);border-radius:16px;padding:14px}
    .modal.show{display:flex}
    .note{font-size:12px;color:var(--muted)}
    /* equal widths */
    .btn.equal{ width:128px }
    @media (max-width:360px){ .btn.equal{ width:112px } }
    /* PATCH 1: + –∫–Ω–æ–ø–∫–∞–º –Ω–µ–±–æ–ª—å—à–æ–π –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –æ—Ç—Å—Ç—É–ø –æ—Ç –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—è –∏ —Å–Ω–∏–∑—É (—É–≤–µ–ª–∏—á–µ–Ω–æ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ) */
    .btn.edge-pad{ margin-right:8px; margin-bottom:16px }
    /* –º–∞–ª–µ–Ω—å–∫–∏–µ –∫–Ω–æ–ø–∫–∏ –≤–Ω—É—Ç—Ä–∏ –ø–ª–∏—Ç–æ–∫ –ª–µ–∫–∞—Ä—Å—Ç–≤ */
    .btn.mini{ height:32px; padding:0 10px; border-radius:10px }
    /* PATCH 3: —è–≤–Ω—ã–π —Ü–≤–µ—Ç —Ç–µ–∫—Å—Ç–∞/–ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–∞ –¥–ª—è input/textarea */
    input.pill, textarea.pill{ color:var(--text); background:var(--glass) }
    input.pill::placeholder, textarea.pill::placeholder{ color:var(--muted) }
    /* PATCH 4: –ø–æ–¥–≥–æ–Ω –ø—Ä–∞–≤–æ–≥–æ –∫—Ä–∞—è ‚Äú–î–æ–¥–∞—Ç–∏‚Äù –ø–æ–¥ –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π –∫–Ω–æ–ø–∫–∏ ‚Äú–í—ñ–¥–∫—Ä–∏—Ç–∏‚Äù –≤ –ø–ª–∏—Ç–∫–∞—Ö */
    #btnAddCircle{ margin-right:10px }
    /* PATCH 5: –æ–¥–∏–Ω–∞–∫–æ–≤–∞—è —à–∏—Ä–∏–Ω–∞ —Å–µ–ª–µ–∫—Ç–æ–≤ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö, —É–º–µ–Ω—å—à–µ–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ */
    .select.wide{ width:120px }
    @media (max-width:420px){ .select.wide{ width:104px } }
  </style>
</head>
<body>
  <header>
    <div class="hdr-left">
      <div class="avatar" id="userAvatar">SC</div>
      <div class="hdr-meta">
        <div class="name" id="userName">SafeConnect</div>
        <div class="sub" id="subLine" data-i18n="app.subtitle">MVP ‚Ä¢ WebApp</div>
      </div>
    </div>
    <div class="hdr-right">
      <div class="pill weather" id="weatherBox">üå°Ô∏è 23¬∞ ‚Ä¢ ‚õÖÔ∏é <span class="muted" id="weatherCity">Kyiv</span></div>
      <div class="pill" id="timeNow">--:--:--</div>
    </div>
  </header>


  <div id="app">
    <main>
      <!-- FEED -->
      <section id="screen-feed" class="screen active">
        <div class="card">
          <div class="row"><div class="h" data-i18n="feed.title">–û–ø–æ–≤—ñ—â–µ–Ω–Ω—è</div>
            <button class="btn" id="btnFilters">‚öôÔ∏è <span data-i18n="feed.filters">–§—ñ–ª—å—Ç—Ä–∏</span></button>
          </div>
          <div class="map">üó∫Ô∏è <span class="muted" data-i18n="map.placeholder">–¢—É—Ç –±—É–¥–µ –∫–∞—Ä—Ç–∞ (–ø—ñ–∑–Ω—ñ—à–µ)</span></div>
        </div>
        <div style="height:10px"></div>
        <div class="list" id="feedList"></div>
      </section>

      <!-- CIRCLES -->
      <section id="screen-circles" class="screen">
        <div class="card">
          <div class="row"><div class="h" data-i18n="circles.title">–ö–æ–ª–∞ –∑–≤'—è–∑–∫—É</div>
            <button class="btn primary equal" id="btnAddCircle" data-i18n="common.add">–î–æ–¥–∞—Ç–∏</button>
          </div>
          <div class="list" id="circleList"></div>
        </div>
        <div style="height:10px"></div>
        <div class="row" style="gap:8px">
          <button class="btn danger" id="btnSOS">üö® <span data-i18n="circles.sos">SOS</span></button>
          <button class="btn" id="btnCheckIn" data-i18n="circles.checkin">–Ø –≤ –ø–æ—Ä—è–¥–∫—É</button>
          <button class="btn" id="btnBroadcast" data-i18n="circles.broadcast">–†–æ–∑—ñ—Å–ª–∞—Ç–∏ ¬´–Ø –≤ –ø–æ—Ä—è–¥–∫—É¬ª</button>
        </div>
      </section>

      <!-- ICE HOME -->
      <section id="screen-ice" class="screen">
        <div class="card">
          <div class="row">
            <div class="h" data-i18n="ice.title">ICE-–ø—Ä–æ—Ñ—ñ–ª—å</div>
            <div style="display:flex; gap:8px">
              <button class="btn" id="btnSetPIN" title="–ó–∞—Ö–∏—Å—Ç–∏—Ç–∏ PIN">üîí PIN</button>
              <button class="btn" id="btnUnlock" title="–†–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏">üîì</button>
              <button class="btn" id="btnLock" title="–ó–∞–±–ª–æ–∫—É–≤–∞—Ç–∏">‚õî</button>
            </div>
          </div>
          <div class="grid cols-2">
            <button class="btn" data-ice="allergies" data-i18n="ice.allergies">–ê–ª–µ—Ä–≥—ñ—ó</button>
            <button class="btn" data-ice="meds" data-i18n="ice.meds">–õ—ñ–∫–∏</button>
            <button class="btn" data-ice="blood" data-i18n="ice.blood">–ì—Ä—É–ø–∞ –∫—Ä–æ–≤—ñ</button>
            <button class="btn" data-ice="docs" data-i18n="ice.docs">–î–æ–∫—É–º–µ–Ω—Ç–∏ (–¥–æ 3 –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ)</button>
          </div>
          <div class="note" style="margin-top:8px" data-i18n="ice.note">
            –î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ —Ç–∞ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ñ (–¥–æ–¥–∞–º–æ –ø—ñ–∑–Ω—ñ—à–µ).
          </div>
          <div class="note" id="iceLockHint" style="margin-top:6px;color:#ffb74d"></div>
        </div>
      </section>


      <!-- ICE SUB: Allergies -->
      <section id="screen-ice-allergies" class="screen">
        <div class="card">
          <div class="row"><div class="h" data-i18n="ice.allergies">–ê–ª–µ—Ä–≥—ñ—ó</div><button class="btn" data-back="ice">‚Üê <span data-i18n="common.back">–ù–∞–∑–∞–¥</span></button></div>
          <textarea id="iceAllergies" class="pill" style="width:100%;height:160px" placeholder="‚Äî"></textarea>
        </div>
      </section>

      <!-- ICE SUB: Meds -->
      <section id="screen-ice-meds" class="screen">
        <div class="card">
          <div class="row"><div class="h" data-i18n="ice.meds">–õ—ñ–∫–∏</div><button class="btn" data-back="ice">‚Üê <span data-i18n="common.back">–ù–∞–∑–∞–¥</span></button></div>
          <div class="row"><div class="muted" data-i18n="ice.meds.critical">–ñ–∏—Ç—Ç—î–≤–æ –≤–∞–∂–ª–∏–≤—ñ</div><button class="btn edge-pad" id="addCrit">Ôºã</button></div>
          <div class="list" id="critList"></div>
          <div style="height:8px"></div>
          <div class="row"><div class="muted" data-i18n="ice.meds.secondary">–î—Ä—É–≥–æ—Ä—è–¥–Ω—ñ</div><button class="btn edge-pad" id="addSec">Ôºã</button></div>
          <div class="list" id="secList"></div>
        </div>
      </section>

      <!-- ICE SUB: Blood -->
      <section id="screen-ice-blood" class="screen">
        <div class="card">
          <div class="row"><div class="h" data-i18n="ice.blood">–ì—Ä—É–ø–∞ –∫—Ä–æ–≤—ñ</div><button class="btn" data-back="ice">‚Üê <span data-i18n="common.back">–ù–∞–∑–∞–¥</span></button></div>
          <input id="iceBlood" class="pill" placeholder="0(I) Rh+" style="width:100%" />
          <div style="height:8px"></div>
          <div class="row"><div class="muted">QR</div><div class="pill" id="qrPlaceholder" style="flex:1;display:flex;align-items:center;gap:8px;justify-content:center">‚óªÔ∏è <span class="muted" data-i18n="ice.qr">QR –∑'—è–≤–∏—Ç—å—Å—è –ø—ñ–∑–Ω—ñ—à–µ</span></div></div>
        </div>
      </section>

      <!-- ICE SUB: Docs -->
      <section id="screen-ice-docs" class="screen">
        <div class="card">
          <div class="row"><div class="h" data-i18n="ice.docs">–î–æ–∫—É–º–µ–Ω—Ç–∏ (–¥–æ 3 –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ)</div><button class="btn" data-back="ice">‚Üê <span data-i18n="common.back">–ù–∞–∑–∞–¥</span></button></div>
          <div class="chips" id="docChips"></div>
        </div>
      </section>

      <!-- SETTINGS -->
      <section id="screen-settings" class="screen">
        <div class="card">
          <div class="h" data-i18n="settings.title">–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è</div>
          <div class="row">
            <div class="muted" data-i18n="settings.lang">–ú–æ–≤–∞</div>
            <select id="langSel" class="select wide">
              <option value="uk">–£–∫—Ä–∞—ó–Ω—Å—å–∫–∞</option>
              <option value="ru">–†—É—Å—Å–∫–∏–π</option>
              <option value="en">English</option>
            </select>
          </div>
          <div style="height:15px"></div> <!-- –£–≤–µ–ª–∏—á–∏–ª –æ—Ç—Å—Ç—É–ø -->
          <div class="row">
            <div class="muted" data-i18n="settings.theme">–¢–µ–º–∞</div>
            <select id="themeSel" class="select wide">
              <option value="dark">Dark</option>
              <option value="midnight">Midnight</option>
              <option value="light">Light</option>
            </select>
          </div>
          <div style="height:15px"></div> <!-- –£–≤–µ–ª–∏—á–∏–ª –æ—Ç—Å—Ç—É–ø -->
          <button class="btn" id="btnPro" data-i18n="settings.goPro">–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ Pro</button>
          <div style="height:15px"></div> <!-- –£–≤–µ–ª–∏—á–∏–ª –æ—Ç—Å—Ç—É–ø -->
          <button class="btn" id="btnDevLogin">Dev login</button>
          <div style="height:10px"></div>
          <div class="note">API: <span id="apiBaseShow">‚Äî</span> <button class="btn mini" id="setApiBaseBtn">URL</button></div>
          <div class="note" id="diagBox" style="margin-top:8px;line-height:1.35"></div>
          <div class="row" style="gap:8px;margin-top:6px">
            <button class="btn mini" id="btnAuthTest">Auth test</button>
            <button class="btn mini" id="btnClearToken">Clear token</button>
          </div>
        </div>
      </section>

      <!-- PRO -->
      <section id="screen-pro" class="screen">
        <div class="card">
          <div class="h" data-i18n="pro.title">SafeConnect Pro ‚Äî $5/–º—ñ—Å</div>
          <ul id="proList">
            <li data-i18n="pro.item1">‚àû –∫–æ–ª–∞, —É—á–∞—Å–Ω–∏–∫–∏, –¥–æ–∫—É–º–µ–Ω—Ç–∏</li>
            <li data-i18n="pro.item2">–ê–≤—Ç–æ-check-in –Ω–∞ —Ç—Ä–∏–≤–æ–≥–∏ + —Å—Ü–µ–Ω–∞—Ä—ñ—ó SOS</li>
            <li data-i18n="pro.item3">–£–º–Ω—ñ –≥–µ–æ–∑–æ–Ω–∏, –æ—Ñ—Ñ–ª–∞–π–Ω-–∫–∞—Ä—Ç–∏, —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è</li>
          </ul>
          <div class="row">
            <button class="btn primary" id="btnBuy" data-i18n="pro.buy">–û–ø–ª–∞—Ç–∏—Ç–∏</button>
            <button class="btn" id="btnTry" data-i18n="pro.try">7 –¥–Ω—ñ–≤ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ</button>
          </div>
        </div>
      </section>
    </main>

    <nav>
      <button class="tab active" data-tab="feed"><div>üì∞</div><span data-i18n="nav.feed">–õ–µ–Ω—Ç–∞</span></button>
      <button class="tab" data-tab="circles"><div>üë•</div><span data-i18n="nav.circles">–ö–æ–ª–∞</span></button>
      <button class="tab" data-tab="ice"><div>‚ùÑÔ∏è</div><span data-i18n="nav.ice">ICE</span></button>
      <button class="tab" data-tab="settings"><div>‚öôÔ∏è</div><span data-i18n="nav.settings">–ù–∞–ª–∞—à—Ç.</span></button>
      <button class="tab" data-tab="pro"><div>‚≠ê</div><span data-i18n="nav.pro">Pro</span></button>
    </nav>
  </div>

  <!-- Modal: Pro upsell -->
  <div class="modal" id="proModal">
    <div class="box">
      <div class="h" data-i18n="modal.title">–û–±–º–µ–∂–µ–Ω–Ω—è –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó</div>
      <p class="muted" data-i18n="modal.text">–í–∏ –¥–æ—Å—è–≥–ª–∏ –ª—ñ–º—ñ—Ç—É (3 –¥–æ–∫—É–º–µ–Ω—Ç–∏ / 1 –∫–æ–ª–æ / 1 –≥–µ–æ–∑–æ–Ω–∞). –†–æ–∑–±–ª–æ–∫—É–π—Ç–µ –≤—Å–µ —É SafeConnect Pro ‚Äî $5/–º—ñ—Å.</p>
      <div class="row">
        <button class="btn" id="proClose" data-i18n="modal.later">–ü—ñ–∑–Ω—ñ—à–µ</button>
        <button class="btn primary" id="proBuyNow" data-i18n="modal.buy">–ö—É–ø–∏—Ç–∏ Pro</button>
      </div>
    </div>
  </div>

  <!-- Modal: Filters placeholder -->
  <div class="modal" id="filtersModal">
    <div class="box">
      <div class="h" data-i18n="filters.title">–§—ñ–ª—å—Ç—Ä–∏</div>
      <div class="row"><span class="muted" data-i18n="filters.type">–¢–∏–ø–∏ –ø–æ–¥—ñ–π</span>
        <div>
          <label class="muted"><input type="checkbox" checked/> UAV</label>
          <label class="muted"><input type="checkbox" checked/> –û–±—Å—Ç—Ä—ñ–ª–∏</label>
          <label class="muted"><input type="checkbox" checked/> –ë–ª–æ–∫–ø–æ—Å—Ç–∏</label>
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="row">
        <button class="btn" id="filtersCancel" data-i18n="filters.cancel">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
        <button class="btn primary" id="filtersApply" data-i18n="filters.apply">–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏</button>
      </div>
    </div>
  </div>
  <!-- Modal: Circle detail -->
    <div class="modal" id="circleModal">
    <div class="box">
        <div class="h" id="circleTitle">–ö–æ–ª–æ</div>
        <div class="list" id="memberList"></div>
        <div class="row" style="margin-top:8px">
        <button class="btn" id="circleClose">–ó–∞–∫—Ä–∏—Ç–∏</button>
        <button class="btn primary" id="circleEdit">–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ (—Å–∫–æ—Ä–æ)</button>
        </div>
    </div>
    </div>


  <script>
    // Ensure DOM is fully parsed before any element access / function calls
    document.addEventListener('DOMContentLoaded', async () => {

      // [E5] ==== API client (REPLACEMENT) ====
      // 1) –ë–µ—Ä—ë–º –±–∞–∑—É –∏–∑ localStorage, –∏–Ω–∞—á–µ ‚Äî dev-–≤–æ—Ä–∫–µ—Ä –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      const API_BASE = (
        localStorage.getItem('sc_api_base') ||
        'https://safeconnect-api-dev.spacewenderer1.workers.dev'
      ).trim();

      // 2) –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –≤ –≥–ª–æ–±–∞–ª, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ —Å–º–æ—Ç—Ä–µ—Ç—å –≤ –∫–æ–Ω—Å–æ–ª–∏
      window.API_BASE = API_BASE;

      // 3) –¢–æ–∫–µ–Ω –∏–∑ localStorage
      let accessToken = localStorage.getItem('sc_access_token') || null;

      // 4) –ö–ª–∏–µ–Ω—Ç —Å CORS
      async function apiFetch(path, opts = {}) {
        if (!API_BASE) throw new Error('API_BASE not set');
        const headers = Object.assign({ 'Content-Type': 'application/json' }, opts.headers || {});
        if (accessToken) headers.Authorization = `Bearer ${accessToken}`;

        const res = await fetch(API_BASE + path, { ...opts, headers, mode: 'cors' });

        // –ï—Å–ª–∏ –∏—Å—Ç—ë–∫/–±–∏—Ç —Ç–æ–∫–µ–Ω ‚Äî –ø–æ—á–∏—Å—Ç–∏–º –∏ –ø–æ–ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ª–æ–≥–∏–Ω–∏—Ç—å—Å—è —á–µ—Ä–µ–∑ Telegram
        if (res.status === 401) {
          localStorage.removeItem('sc_access_token');
          accessToken = null;
          await renderDiag({ note: `401 on ${path}` });
          // –µ—Å–ª–∏ –º—ã –≤ Telegram ‚Äî –ø—Ä–æ–±—É–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é
          try { await tryTelegramAuth(); } catch {}
          throw new Error(`API ${path} 401`);
        }

        if (!res.ok) {
          throw new Error(`API ${path} ${res.status}`);
        }
        const json = await res.json();
        await renderDiag(); // –æ–±–Ω–æ–≤–∏–º –¥–∏–∞–≥–Ω–æ–∑ –ø–æ —Ñ–∞–∫—Ç—É —É–¥–∞—á–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
        return json;
      }

      // 5) –°–º–µ–Ω–∞ –±–∞–∑—ã —á–µ—Ä–µ–∑ UI (–∫–Ω–æ–ø–∫–∞ "URL")
      function setApiBase(u) {
        localStorage.setItem('sc_api_base', String(u || '').trim());
        location.reload();
      }
      window.setApiBase = setApiBase
      

      /********************
       *  CLOCK (Kyiv) + Weather placeholder
       ********************/
      const timeEl = document.getElementById('timeNow');
      const weatherBox = document.getElementById('weatherBox');
      const weatherCityEl = document.getElementById('weatherCity');
      function tick(){
        const now = new Date();
        timeEl.textContent = now.toLocaleTimeString('uk-UA', {timeZone:'Europe/Kyiv', hour12:false});
      }
      setInterval(tick, 1000); tick();
      // Weather mock (Kyiv). Later: replace with API and user's city.
      let weather = { cityKey:'kyiv', tempC:23, icon:'‚õÖÔ∏é', text:{uk:'–•–º–∞—Ä–Ω–æ',ru:'–û–±–ª–∞—á–Ω–æ',en:'Cloudy'} };


      /********************
       *  IndexedDB KV (sc -> kv)
       ********************/
      const DB = (() => {
        const dbName = 'sc';
        const store = 'kv';
        let db;
        function open() {
          return new Promise((resolve, reject) => {
            try{
              const req = indexedDB.open(dbName, 1);
              req.onupgradeneeded = (e) => {
                const d = e.target.result;
                if (!d.objectStoreNames.contains(store)) d.createObjectStore(store, { keyPath: 'k' });
              };
              req.onsuccess = () => { db = req.result; resolve(); };
              req.onerror = () => reject(req.error);
            }catch(err){
              reject(err);
            }
          });
        }
        async function get(k) {
          if (!db) await open();
          return new Promise((resolve, reject) => {
            const tx = db.transaction(store, 'readonly').objectStore(store).get(k);
            tx.onsuccess = () => resolve(tx.result ? tx.result.v : undefined);
            tx.onerror = () => reject(tx.error);
          });
        }
        async function set(k, v) {
          if (!db) await open();
          return new Promise((resolve, reject) => {
            const tx = db.transaction(store, 'readwrite').objectStore(store).put({ k, v });
            tx.onsuccess = () => resolve();
            tx.onerror = () => reject(tx.error);
          });
        }
        async function merge(k, part) {
          const cur = (await get(k)) || {};
          const next = { ...cur, ...part };
          await set(k, next);
          return next;
        }
      // Fallback: –µ—Å–ª–∏ open() —É–ø–∞–ª, –∏—Å–ø–æ–ª—å–∑—É–µ–º localStorage –ø–æ–¥ –∫–ª—é—á–æ–º "__sc_fallback"
      const _fallback = {
        get kvm(){ try{ return JSON.parse(localStorage.getItem('__sc_fallback')||'{}'); }catch{ return {}; } },
        set kvm(v){ localStorage.setItem('__sc_fallback', JSON.stringify(v)); }
      };

      async function safeCall(fn, ...args){
        try{ return await fn(...args); }
        catch(e){
          // fallback —Ä–µ–∂–∏–º
          if (fn===get)  { const o=_fallback.kvm; return o[args[0]]; }
          if (fn===set)  { const o=_fallback.kvm; o[args[0]] = args[1]; _fallback.kvm = o; return; }
          if (fn===merge){ const cur = (await safeCall(get, args[0]))||{}; const next={...cur, ...args[1]}; await safeCall(set, args[0], next); return next; }
          throw e;
        }
      }

      // –ø—Ä–æ–∫—Å–∏-–≤–æ–∑–≤—Ä–∞—Ç, —á—Ç–æ–±—ã –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å safeCall
      return {
        get: (k)=>safeCall(get,k),
        set: (k,v)=>safeCall(set,k,v),
        merge: (k,part)=>safeCall(merge,k,part)
      };

      })();

      /********************
       *  CRYPTO (WebCrypto AES-GCM + PBKDF2)
       ********************/
      const CryptoSC = (() => {
        const enc = new TextEncoder();
        const dec = new TextDecoder();

        async function sha256(buf){ return crypto.subtle.digest('SHA-256', buf); }

        function randBytes(len=12){
          const a = new Uint8Array(len);
          crypto.getRandomValues(a);
          return a;
          }

        async function deriveKeyFromPIN(pin, salt, iter=100_000){
          const base = await crypto.subtle.importKey(
            'raw', enc.encode(pin), 'PBKDF2', false, ['deriveKey']
          );
          return crypto.subtle.deriveKey(
            {name:'PBKDF2', salt, iterations: iter, hash:'SHA-256'},
            base,
            {name:'AES-GCM', length:256},
            false,
            ['encrypt','decrypt']
          );
        }

        async function encryptJSON(key, obj){
          const iv = randBytes(12);
          const data = enc.encode(JSON.stringify(obj));
          const ct = await crypto.subtle.encrypt({name:'AES-GCM', iv}, key, data);
          return { ct: btoa(String.fromCharCode(...new Uint8Array(ct))), iv: btoa(String.fromCharCode(...iv)), ts: Date.now() };
        }

        async function decryptJSON(key, payload){
          const iv = Uint8Array.from(atob(payload.iv), c=>c.charCodeAt(0));
          const ct = Uint8Array.from(atob(payload.ct), c=>c.charCodeAt(0));
          const pt = await crypto.subtle.decrypt({name:'AES-GCM', iv}, key, ct);
          return JSON.parse(dec.decode(new Uint8Array(pt)));
        }

        return { deriveKeyFromPIN, encryptJSON, decryptJSON, randBytes };
      })();


      /********************
       *  STATE (default) + load/save
       ********************/


      /********************
       *  SCHEMA & migrations
       ********************/
      const SCHEMA_VERSION = 1;

      async function runMigrations(current) {
        // –ø—Ä–∏–º–µ—Ä –Ω–∞ –±—É–¥—É—â–µ–µ:
        // if (current < 2) { /* migrate to v2 */ }
        return SCHEMA_VERSION;
      }

      /********************
       *  STATE (default) + load/save
       ********************/
      const DEFAULT_STATE = {
        lang: 'uk',
        theme: 'dark',
        circles: [],               // ‚Üê –±—ã–ª–æ —Å "Family", —Ç–µ–ø–µ—Ä—å –ø—É—Å—Ç–æ
        docs: [],
        ice: { allergies: '', blood: '', medsCrit: [], medsSec: [] },
        iceLocked: false
      };


        let state = { ...DEFAULT_STATE };

        async function loadState() {
          const schema = (await DB.get('schema')) || 0;
          const newVer = await runMigrations(schema);
          if (newVer !== schema) await DB.set('schema', newVer);

          const saved = (await DB.get('state')) || {};
          const sec   = (await DB.get('sec'))   || { hasPIN:false };

          state = {
            ...DEFAULT_STATE,
            ...saved,
            ice: { ...DEFAULT_STATE.ice, ...(saved.ice || {}) }
          };

          // –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ PIN ‚Äî –Ω–µ –ø–æ–¥–Ω–∏–º–∞—Ç—å ICE –≤ –ø–∞–º—è—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
          if (sec.hasPIN) {
            state.iceLocked = true;
            state.ice = { ...DEFAULT_STATE.ice }; // –æ—á–∏—â–∞–µ–º –ø–æ–ª—è –≤ –ø–∞–º—è—Ç–∏
          }

          // –Ω–∞–ø–æ–ª–Ω—è–µ–º –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω—ã–µ –º–∞—Å—Å–∏–≤—ã
          circles = state.circles.slice();
          docs    = state.docs.slice();
        } // B2: Modified loadState to handle encryption

        async function saveState(part) {
          // –ø–æ–¥—Ç—è–≥–∏–≤–∞–µ–º sec, —á—Ç–æ–±—ã –∑–Ω–∞—Ç—å ‚Äî –Ω–∞–¥–æ –ª–∏ —à–∏—Ñ—Ä–æ–≤–∞—Ç—å ICE
          const sec = (await DB.get('sec')) || { hasPIN:false };

          // –æ–±–Ω–æ–≤–ª—è–µ–º in-memory
          if (part) {
            if (part.ice) state.ice = { ...state.ice, ...part.ice };
            if (Array.isArray(part.circles)) state.circles = part.circles.slice();
            if (Array.isArray(part.docs)) state.docs = part.docs.slice();
            if (typeof part.lang === 'string') state.lang = part.lang;
            if (typeof part.theme === 'string') state.theme = part.theme;
            if (typeof part.iceLocked === 'boolean') state.iceLocked = part.iceLocked;
          }

          // –µ—Å–ª–∏ –µ—Å—Ç—å PIN ‚Äî ICE –≤ state –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –æ—Ç–∫—Ä—ã—Ç—É—é
          let toPersistICE = state.ice;
          if (sec.hasPIN) {
            // –Ω–µ —Ö—Ä–∞–Ω–∏—Ç—å ICE –≤ state (–æ–Ω —É–π–¥—ë—Ç –≤ cipher-–∫–ª—é—á)
            toPersistICE = undefined;
            await DB.set('state', {
              lang: state.lang,
              theme: state.theme,
              circles: state.circles,
              docs: state.docs,
              iceLocked: true
            });
            return; // —Å–∞–º —à–∏—Ñ—Ä–æ—Ç–µ–∫—Å—Ç –ø–∏—à–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ (—Å–º. –Ω–∏–∂–µ)
          }

          // –æ–±—ã—á–Ω–∞—è –≤–µ—Ç–∫–∞ ‚Äî –±–µ–∑ PIN
          await DB.set('state', {
            lang: state.lang,
            theme: state.theme,
            circles: state.circles,
            docs: state.docs,
            ice: toPersistICE,
            iceLocked: false
          });
        }

      /********************
         *  PIN / Lock helpers
         ********************/
        // –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å/—Å–º–µ–Ω–∏—Ç—å PIN: —à–∏—Ñ—Ä—É–µ–º —Ç–µ–∫—É—â–∏–π state.ice –∏ —á–∏—Å—Ç–∏–º –µ–≥–æ –∏–∑ state
        async function setPIN() {
          const pin = prompt('–í—Å—Ç–∞–Ω–æ–≤—ñ—Ç—å PIN (4‚Äì8 —Ü–∏—Ñ—Ä):') || '';
          if (!/^\d{4,8}$/.test(pin)) { alert('PIN –º–∞—î –º—ñ—Å—Ç–∏—Ç–∏ 4‚Äì8 —Ü–∏—Ñ—Ä'); return; }

          const salt = CryptoSC.randBytes(16);
          const iter = 120_000;
          const key  = await CryptoSC.deriveKeyFromPIN(pin, salt, iter);

          const icePayload = await CryptoSC.encryptJSON(key, state.ice);

          await DB.set('ice_cipher', icePayload);
          await DB.set('sec', { hasPIN:true, salt: btoa(String.fromCharCode(...salt)), iter });

          await saveState({ ice: undefined, iceLocked: true });
          renderICEStatus();
          /* PATCH Opt: —Å—Ä–∞–∑—É —Å–∫—Ä—ã—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –Ω–∞ —ç–∫—Ä–∞–Ω–µ –ø–æ—Å–ª–µ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ PIN */
          if(iceAllergiesEl) iceAllergiesEl.value = '';
          if(iceBloodEl)     iceBloodEl.value     = '';
          renderMedsLists();
          alert('PIN –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ. –î–∞–Ω—ñ ICE –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ñ.');
        }

        // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å ICE –ø–æ PIN
        async function unlockICE() {
          const sec = (await DB.get('sec')) || { hasPIN:false };
          if (!sec.hasPIN) { alert('PIN –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π'); return; }
          const pin = prompt('–í–≤–µ–¥—ñ—Ç—å PIN:') || '';
          if (!/^\d{4,8}$/.test(pin)) { alert('–ù–µ–≤—ñ—Ä–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç PIN'); return; }

          try{
            const salt = Uint8Array.from(atob(sec.salt), c=>c.charCodeAt(0));
            const key  = await CryptoSC.deriveKeyFromPIN(pin, salt, sec.iter || 120_000);
            const cipher = await DB.get('ice_cipher');
            if (!cipher) throw new Error('–ù–µ–º–∞—î —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—Ö –¥–∞–Ω–∏—Ö');

            const ice = await CryptoSC.decryptJSON(key, cipher);
            state.ice = { ...DEFAULT_STATE.ice, ...ice };
            await saveState({ iceLocked: false }); // state.ice –æ—Å—Ç–∞–≤–ª—è–µ–º –≤ –ø–∞–º—è—Ç–∏, –Ω–æ –Ω–µ –ø–∏—à–µ–º –≤ state –ø—Ä–∏ hasPIN
            renderMedsLists(); // –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ ‚Äú–õ—ñ–∫–∏‚Äù –æ—Ç–∫—Ä—ã—Ç–∞
            renderICEStatus(); // <-- –¥–æ–±–∞–≤–∏—Ç—å
            alert('ICE —Ä–æ–∑–±–ª–æ–∫–æ–≤–∞–Ω–æ –≤ –ø–∞–º\'—è—Ç—ñ (–¥–æ –ø–µ—Ä–µ–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è).');

            // –ó–∞–ø–æ–º–Ω–∏–º –∫–ª—é—á –≤ —Å–∫–æ—É–ø–µ —Å–µ—Å—Å–∏–∏ (–Ω–µ –≤ IndexedDB!)
            window.__sc_session_key = key;
          }catch(e){
            console.error(e);
            alert('–ù–µ–≤—ñ—Ä–Ω–∏–π PIN –∞–±–æ –ø–æ—à–∫–æ–¥–∂–µ–Ω—ñ –¥–∞–Ω—ñ.');
          }
        }

        // –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å ICE (–Ω–µ —É–¥–∞–ª—è–µ—Ç —à–∏—Ñ—Ä–æ—Ç–µ–∫—Å—Ç)
        async function lockICE() {
          state.ice = { ...DEFAULT_STATE.ice };
          await saveState({ iceLocked: true });
          renderICEStatus(); 
          alert('ICE –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ.');
        }

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ ICE: –µ—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω PIN ‚Äî —à–∏—Ñ—Ä—É–µ–º ‚Äú–ø—Ä—è–º–æ —Å–µ–π—á–∞—Å‚Äù
        async function persistICEIfProtected() {
          const sec = (await DB.get('sec')) || { hasPIN:false };
          if (!sec.hasPIN) return; // –æ–±—ã—á–Ω–∞—è –≤–µ—Ç–∫–∞ ‚Äî –±–µ–∑ PIN

          try {
            let key = window.__sc_session_key;
            if (!key) {
              // –ø–æ–ø—Ä–æ—Å–∏—Ç—å PIN –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ, —á—Ç–æ–±—ã —Å—Ç–≤–æ—Ä–∏—Ç–∏ –∫–ª—é—á –≤ —Å–µ—Å—ñ—ó
              const pin = prompt('PIN –¥–ª—è —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è:') || '';
              if (!/^\d{4,8}$/.test(pin)) throw new Error('Bad PIN');
              const salt = Uint8Array.from(atob(sec.salt), c=>c.charCodeAt(0));
              key = await CryptoSC.deriveKeyFromPIN(pin, salt, sec.iter || 120_000);
              window.__sc_session_key = key;
            }
            const payload = await CryptoSC.encryptJSON(key, state.ice);
            await DB.set('ice_cipher', payload);
            // state —É–∂–µ –∑–∞–ø–∏—Å–∞–Ω –±–µ–∑ ice, –∞ iceLocked=false —Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏
          } catch (e) {
            console.error(e);
            alert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞—à–∏—Ñ—Ä—É–≤–∞—Ç–∏ ICE: –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ PIN.');
          }
        }

      // Telegram WebApp shim (safe outside Telegram)
      let tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;

      // Stage 2: Telegram WebApp integration (safe outside Telegram)
      const userNameEl = document.getElementById('userName');
      const userAvatarEl = document.getElementById('userAvatar');

      function applyThemeFromTelegram(){
        if(!tg) return;
        // –ï—Å–ª–∏ —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ —Ç–µ–º–∞ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
        const userSaved = (typeof state !== 'undefined' && state && state.theme) || localStorage.getItem('sc_theme');
        if (userSaved) return;

        const scheme = tg.colorScheme === 'light' ? 'light' : 'dark';
        applyTheme(scheme);
        const sel = document.getElementById('themeSel'); if(sel) sel.value = scheme;
      }

      function updateBackButton(tab){
        if(!tg) return;
        const roots = ['feed','circles','ice','settings','pro'];
        if(roots.includes(tab)) tg.BackButton.hide(); else tg.BackButton.show();
      }
      function updateMainButton(tab){
        if(!tg) return;
        if(tab==='pro'){
          const txt = document.querySelector('[data-i18n="pro.buy"]').textContent || 'Buy Pro';
          tg.MainButton.setParams({text:txt, is_active:true, is_visible:true});
          tg.MainButton.show();
        } else { tg.MainButton.hide(); }
      }
      function initTelegram(){
        if(!tg) return;
        try{ tg.ready(); tg.expand(); }catch(e){}
        applyThemeFromTelegram();
        const u = tg.initDataUnsafe && tg.initDataUnsafe.user ? tg.initDataUnsafe.user : null;
        if(u){
          const full = `${u.first_name||''} ${u.last_name||''}`.trim();
          if(full) userNameEl.textContent = full;
          const initials = `${(u.first_name||'S').charAt(0)}${(u.last_name||'C').charAt(0)}`.toUpperCase();
          userAvatarEl.textContent = initials || 'SC';
        }
        tg.onEvent('themeChanged', ()=>applyThemeFromTelegram());
        tg.onEvent('backButtonClicked', ()=>{ history.back(); });
        tg.onEvent('mainButtonClicked', ()=>{ const b=document.getElementById('btnBuy'); if(b) b.click(); });
      }
      // Haptics for taps
      document.addEventListener('click', (e)=>{ if(tg && tg.HapticFeedback){ const el=e.target.closest('.btn, nav .tab, .chip'); if(el){ try{ tg.HapticFeedback.impactOccurred('light'); }catch(e){} } } });


      /********************
       *  SIMPLE ROUTER
       ********************/
      const tabs = document.querySelectorAll('nav .tab');
      const screens = {
        feed: document.getElementById('screen-feed'),
        circles: document.getElementById('screen-circles'),
        ice: document.getElementById('screen-ice'),
        settings: document.getElementById('screen-settings'),
        pro: document.getElementById('screen-pro'),
        'ice-allergies': document.getElementById('screen-ice-allergies'),
        'ice-meds': document.getElementById('screen-ice-meds'),
        'ice-blood': document.getElementById('screen-ice-blood'),
        'ice-docs': document.getElementById('screen-ice-docs'),
      };
      function go(tab){
        for(const t of tabs) t.classList.toggle('active', t.dataset.tab===tab);
        for(const k in screens) screens[k].classList.toggle('active', k===tab);
        history.replaceState({}, '', `#${tab}`);
        if (typeof updateBackButton==='function') updateBackButton(tab);
        if (typeof updateMainButton==='function') updateMainButton(tab);
      }
      tabs.forEach(b=>b.addEventListener('click',()=>go(b.dataset.tab)));
      const initialHash = location.hash.replace('#','');
      if(screens[initialHash]) go(initialHash); else go('feed');
      // ICE navigation
      document.querySelectorAll('[data-ice]').forEach(btn=>btn.addEventListener('click',()=>{
        go('ice-'+btn.getAttribute('data-ice'));
      }));
      document.querySelectorAll('[data-back]').forEach(btn=>btn.addEventListener('click',()=>{
        go(btn.getAttribute('data-back'));
      }));

      /********************
       *  DOM refs used by renderers MUST be declared before i18n.applyLang() calls
       ********************/
      const feedList = document.getElementById('feedList');
      const circleList = document.getElementById('circleList');
      const docChips = document.getElementById('docChips');

      /********************
       *  DATA (feed, circles, limits)
       ********************/
      const FREE_LIMITS = { docs:3, circles:1 };
      const feedData = [
        { id:1, type:'uav', level:'warn', when:Date.now()-5*60*1000, area:'kyiv_obl', textKey:'feed.ev1' },
        { id:2, type:'shelling', level:'danger', when:Date.now()-12*60*1000, area:'kharkiv_raion', textKey:'feed.ev2' },
        { id:3, type:'blockpost', level:'info', when:Date.now()-25*60*1000, area:'dnipro', textKey:'feed.ev3' },
      ];
      let circles = []; // –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –∏–∑ loadState()
      let docs = [];    // –∑–∞–ø–æ–ª–Ω–∏—Ç—Å—è –∏–∑ loadState()


      /********************
       *  I18N (uk/ru/en) ‚Äî global
       ********************/
      const i18n = {
        uk: { 'app.subtitle':'MVP ‚Ä¢ WebApp',
              'nav.feed':'–õ–µ–Ω—Ç–∞','nav.circles':'–ö–æ–ª–∞','nav.ice':'ICE','nav.settings':'–ù–∞–ª–∞—à—Ç.','nav.pro':'Pro',
              'feed.title':'–û–ø–æ–≤—ñ—â–µ–Ω–Ω—è','feed.filters':'–§—ñ–ª—å—Ç—Ä–∏','map.placeholder':'–¢—É—Ç –±—É–¥–µ –∫–∞—Ä—Ç–∞ (–ø—ñ–∑–Ω—ñ—à–µ)',
              'circles.title':'–ö–æ–ª–∞ –∑–≤\'—è–∑–∫—É','circles.checkin':'–Ø –≤ –ø–æ—Ä—è–¥–∫—É','circles.sos':'SOS','circles.broadcast':'–†–æ–∑—ñ—Å–ª–∞—Ç–∏ ¬´–Ø –≤ –ø–æ—Ä—è–¥–∫—É¬ª','circle.open':'–í—ñ–¥–∫—Ä–∏—Ç–∏','circle.members':'—É—á–∞—Å–Ω.', 'circle.family':'–°—ñ–º\'—è',
              'ice.title':'ICE-–ø—Ä–æ—Ñ—ñ–ª—å','ice.allergies':'–ê–ª–µ—Ä–≥—ñ—ó','ice.meds':'–õ—ñ–∫–∏','ice.meds.critical':'–ñ–∏—Ç—Ç—î–≤–æ –≤–∞–∂–ª–∏–≤—ñ','ice.meds.secondary':'–î—Ä—É–≥–æ—Ä—è–¥–Ω—ñ','ice.blood':'–ì—Ä—É–ø–∞ –∫—Ä–æ–≤—ñ','ice.docs':'–î–æ–∫—É–º–µ–Ω—Ç–∏ (–¥–æ 3 –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ)','ice.qr':'QR –∑\'—è–≤–∏—Ç—å—Å—è –ø—ñ–∑–Ω—ñ—à–µ','ice.note':'–î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ —Ç–∞ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ñ (–¥–æ–¥–∞–º–æ –ø—ñ–∑–Ω—ñ—à–µ).',
              'settings.title':'–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è','settings.lang':'–ú–æ–≤–∞','settings.theme':'–¢–µ–º–∞','settings.goPro':'–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ Pro',
              'pro.title':'SafeConnect Pro ‚Äî $5/–º—ñ—Å','pro.item1':'‚àû –∫–æ–ª–∞, —É—á–∞—Å–Ω–∏–∫–∏, –¥–æ–∫—É–º–µ–Ω—Ç–∏','pro.item2':'–ê–≤—Ç–æ-check-in –Ω–∞ —Ç—Ä–∏–≤–æ–≥–∏ + —Å—Ü–µ–Ω–∞—Ä—ñ—ó SOS','pro.item3':'–£–º–Ω—ñ –≥–µ–æ–∑–æ–Ω–∏, –æ—Ñ—Ñ–ª–∞–π–Ω-–∫–∞—Ä—Ç–∏, —Å–∏–Ω—Ö—Ä–æ–Ω—ñ–∑–∞—Ü—ñ—è','pro.buy':'–û–ø–ª–∞—Ç–∏—Ç–∏','pro.try':'7 –¥–Ω—ñ–≤ –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ',
              'filters.title':'–§—ñ–ª—å—Ç—Ä–∏','filters.type':'–¢–∏–ø–∏ –ø–æ–¥—ñ–π','filters.cancel':'–°–∫–∞—Å—É–≤–∞—Ç–∏','filters.apply':'–ó–∞—Å—Ç–æ—Å—É–≤–∞—Ç–∏',
              'modal.title':'–û–±–º–µ–∂–µ–Ω–Ω—è –±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–æ—ó –≤–µ—Ä—Å—ñ—ó','modal.text':'–í–∏ –¥–æ—Å—è–≥–ª–∏ –ª—ñ–º—ñ—Ç—É (3 –¥–æ–∫—É–º–µ–Ω—Ç–∏ / 1 –∫–æ–ª–æ / 1 –≥–µ–æ–∑–æ–Ω–∞). –†–æ–∑–±–ª–æ–∫—É–π—Ç–µ –≤—Å–µ —É SafeConnect Pro ‚Äî $5/–º—ñ—Å.','modal.later':'–ü—ñ–∑–Ω—ñ—à–µ','modal.buy':'–ö—É–ø–∏—Ç–∏ Pro',
              'common.add':'–î–æ–¥–∞—Ç–∏','common.back':'–ù–∞–∑–∞–¥',
              'weather.city.kyiv':'–ö–∏—ó–≤', 'level.high':'–í–∏—Å–æ–∫–∏–π', 'level.warn':'–ü–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è', 'level.info':'–Ü–Ω—Ñ–æ',
              'area.kyiv_obl':'–ö–∏—ó–≤—Å—å–∫–∞ –æ–±–ª.', 'area.kharkiv_raion':'–•–∞—Ä–∫—ñ–≤—Å—å–∫–∏–π —Ä-–Ω', 'area.dnipro':'–î–Ω—ñ–ø—Ä–æ',
              'feed.ev1':'–ú–æ–∂–µ –±—É—Ç–∏ –∞–∫—Ç–∏–≤–Ω—ñ—Å—Ç—å –ë–ø–õ–ê', 'feed.ev2':'–†–∏–∑–∏–∫ –æ–±—Å—Ç—Ä—ñ–ª—ñ–≤', 'feed.ev3':'–ù–æ–≤–∏–π –±–ª–æ–∫–ø–æ—Å—Ç –Ω–∞ –≤–∏—ó–∑–¥—ñ' },
        ru: { 'app.subtitle':'MVP ‚Ä¢ WebApp',
              'nav.feed':'–õ–µ–Ω—Ç–∞','nav.circles':'–ö—Ä—É–≥–∏','nav.ice':'ICE','nav.settings':'–ù–∞—Å—Ç—Ä.','nav.pro':'Pro',
              'feed.title':'–û–ø–æ–≤–µ—â–µ–Ω–∏—è','feed.filters':'–§–∏–ª—å—Ç—Ä—ã','map.placeholder':'–ó–¥–µ—Å—å –±—É–¥–µ—Ç –∫–∞—Ä—Ç–∞ (–ø–æ–∑–∂–µ)',
              'circles.title':'–ö—Ä—É–≥–∏ —Å–≤—è–∑–∏','circles.checkin':'–Ø –≤ –ø–æ—Ä—è–¥–∫–µ','circles.sos':'SOS','circles.broadcast':'–†–∞–∑–æ—Å–ª–∞—Ç—å ¬´–Ø –≤ –ø–æ—Ä—è–¥–∫–µ¬ª','circle.open':'–û—Ç–∫—Ä—ã—Ç—å','circle.members':'—É—á–∞—Å—Ç–Ω.', 'circle.family':'–°–µ–º—å—è',
              'ice.title':'ICE-–ø—Ä–æ—Ñ–∏–ª—å','ice.allergies':'–ê–ª–ª–µ—Ä–≥–∏–∏','ice.meds':'–õ–µ–∫–∞—Ä—Å—Ç–≤–∞','ice.meds.critical':'–ñ–∏–∑–Ω–µ–Ω–Ω–æ –≤–∞–∂–Ω—ã–µ','ice.meds.secondary':'–í—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω—ã–µ','ice.blood':'–ì—Ä—É–ø–ø–∞ –∫—Ä–æ–≤–∏','ice.docs':'–î–æ–∫—É–º–µ–Ω—Ç—ã (–¥–æ 3 –±–µ—Å–ø–ª–∞—Ç–Ω–æ)','ice.qr':'QR –ø–æ—è–≤–∏—Ç—Å—è –ø–æ–∑–∂–µ','ice.note':'–î–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –∏ –º–æ–≥—É—Ç –±—ã—Ç—å –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ã (–¥–æ–±–∞–≤–∏–º –ø–æ–∑–∂–µ).',
              'settings.title':'–ù–∞—Å—Ç—Ä–æ–π–∫–∏','settings.lang':'–Ø–∑—ã–∫','settings.theme':'–¢–µ–º–∞','settings.goPro':'–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ Pro',
              'pro.title':'SafeConnect Pro ‚Äî $5/–º–µ—Å','pro.item1':'‚àû –∫—Ä—É–≥–∏, —É—á–∞—Å—Ç–Ω–∏–∫–∏, –¥–æ–∫—É–º–µ–Ω—Ç—ã','pro.item2':'–ê–≤—Ç–æ-check-in –Ω–∞ —Ç—Ä–µ–≤–æ–≥–∏ + —Å—Ü–µ–Ω–∞—Ä–∏–∏ SOS','pro.item3':'–£–º–Ω—ã–µ –≥–µ–æ–∑–æ–Ω—ã, –æ—Ñ—Ñ–ª–∞–π–Ω-–∫–∞—Ä—Ç—ã, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è','pro.buy':'–û–ø–ª–∞—Ç–∏—Ç—å','pro.try':'7 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ',
              'filters.title':'–§–∏–ª—å—Ç—Ä—ã','filters.type':'–¢–∏–ø—ã —Å–æ–±—ã—Ç–∏–π','filters.cancel':'–û—Ç–º–µ–Ω–∞','filters.apply':'–ü—Ä–∏–º–µ–Ω–∏—Ç—å',
              'modal.title':'–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –±–µ—Å–ø–ª–∞—Ç–Ω–æ–π –≤–µ—Ä—Å–∏–∏','modal.text':'–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ –ª–∏–º–∏—Ç–∞ (3 –¥–æ–∫—É–º–µ–Ω—Ç–∞ / 1 –∫—Ä—É–≥ / 1 –≥–µ–æ–∑–æ–Ω–∞). –†–∞–∑–±–ª–æ–∫–∏—Ä—É–π—Ç–µ –≤—Å—ë –≤ SafeConnect Pro ‚Äî $5/–º–µ—Å.','modal.later':'–ü–æ–∑–∂–µ','modal.buy':'–ö—É–ø–∏—Ç—å Pro',
              'common.add':'–î–æ–±–∞–≤–∏—Ç—å','common.back':'–ù–∞–∑–∞–¥',
              'weather.city.kyiv':'–ö–∏–µ–≤', 'level.high':'–í—ã—Å–æ–∫–∏–π', 'level.warn':'–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ', 'level.info':'–ò–Ω—Ñ–æ',
              'area.kyiv_obl':'–ö–∏–µ–≤—Å–∫–∞—è –æ–±–ª.', 'area.kharkiv_raion':'–•–∞—Ä—å–∫–æ–≤—Å–∫–∏–π —Ä-–Ω', 'area.dnipro':'–î–Ω–µ–ø—Ä',
              'feed.ev1':'–í–æ–∑–º–æ–∂–Ω–∞ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –ë–ü–õ–ê', 'feed.ev2':'–†–∏—Å–∫ –æ–±—Å—Ç—Ä–µ–ª–æ–≤', 'feed.ev3':'–ù–æ–≤—ã–π –±–ª–æ–∫–ø–æ—Å—Ç –Ω–∞ –≤—ã–µ–∑–¥–µ' },
        en: { 'app.subtitle':'MVP ‚Ä¢ WebApp',
              'nav.feed':'Feed','nav.circles':'Circles','nav.ice':'ICE','nav.settings':'Settings','nav.pro':'Pro',
              'feed.title':'Alerts','feed.filters':'Filters','map.placeholder':'Map will be here (later)',
              'circles.title':'Circles','circles.checkin':'I\'m safe','circles.sos':'SOS','circles.broadcast':'Broadcast "I\'m safe"','circle.open':'Open','circle.members':'members', 'circle.family':'Family',
              'ice.title':'ICE Profile','ice.allergies':'Allergies','ice.meds':'Medication','ice.meds.critical':'Critical','ice.meds.secondary':'Secondary','ice.blood':'Blood type','ice.docs':'Documents (up to 3 free)','ice.qr':'QR will appear later','ice.note':'Data is stored locally and can be encrypted (coming soon).',
              'settings.title':'Settings','settings.lang':'Language','settings.theme':'Theme','settings.goPro':'Go Pro',
              'pro.title':'SafeConnect Pro ‚Äî $5/mo','pro.item1':'‚àû circles, members, documents','pro.item2':'Auto check-in on alerts + SOS scripts','pro.item3':'Smart geozones, offline maps, sync','pro.buy':'Buy','pro.try':'7 days free',
              'filters.title':'Filters','filters.type':'Event types','filters.cancel':'Cancel','filters.apply':'Apply',
              'modal.title':'Free plan limits','modal.text':'You reached the limit (3 docs / 1 circle / 1 geozone). Unlock all in SafeConnect Pro ‚Äî $5/mo.','modal.later':'Later','modal.buy':'Buy Pro',
              'common.add':'Add','common.back':'Back',
              'weather.city.kyiv':'Kyiv', 'level.high':'High', 'level.warn':'Warning', 'level.info':'Info',
              'area.kyiv_obl':'Kyiv Oblast', 'area.kharkiv_raion':'Kharkiv Raion', 'area.dnipro':'Dnipro',
              'feed.ev1':'Possible UAV activity', 'feed.ev2':'Shelling risk', 'feed.ev3':'New checkpoint at exit' }
      };
      const langSel = document.getElementById('langSel');
      langSel.addEventListener('change', async () => { await applyLang(langSel.value); });
      function t(key){
        const code = localStorage.getItem('sc_lang')||'uk';
        const dict = i18n[code]||i18n.uk; return dict[key]||key;
      }

      // –∑–∞–≥—Ä—É–∑–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ –ø–µ—Ä–≤–∏—á–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä
      await loadState();

      // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω —É–∂–µ –µ—Å—Ç—å (—Ä–∞–Ω—å—à–µ –ª–æ–≥–∏–Ω–∏–ª–∏—Å—å) ‚Äî —Å—Ä–∞–∑—É –ø–æ–¥—Ç—è–Ω—É—Ç—å –¥–∞–Ω–Ω—ã–µ
      if (accessToken) {
        try { await syncFromServer(); } catch(e){ console.warn('initial sync failed', e); }
      }


      // –ø—Ä–∏–º–µ–Ω—è–µ–º —è–∑—ã–∫ –∏–∑ state (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç state –Ω–∞–¥ localStorage)
      localStorage.setItem('sc_lang', state.lang);
      langSel.value = state.lang;

      // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ICE –ø–æ–ª—è
      const iceAllergiesEl = document.getElementById('iceAllergies');
      const iceBloodEl = document.getElementById('iceBlood');
      if (iceAllergiesEl) iceAllergiesEl.value = state.ice.allergies || '';
      if (iceBloodEl) iceBloodEl.value = state.ice.blood || '';


      /********************
       *  FEED render helpers (depend on t, feedList)
       ********************/
      function levelBadge(level){
        const cls = level==='danger'?'danger': level==='warn'?'warn':'';
        const label = level==='danger'? t('level.high'): level==='warn'? t('level.warn'): t('level.info');
        return `<span class="badge ${cls}">${label}</span>`;
      }
      function renderFeed(){
        const code = localStorage.getItem('sc_lang')||'uk';
        feedList.innerHTML = feedData.map(ev=>`<div class="tile">
          <div class="row"><div>${levelBadge(ev.level)} <span class="muted">${new Date(ev.when).toLocaleTimeString(code==='en'?'en-GB':code==='ru'?'ru-RU':'uk-UA',{hour:'2-digit',minute:'2-digit'})}</span></div>
            <div class="muted">${t('area.'+ev.area)}</div></div>
          <div style="margin-top:6px">${t(ev.textKey)}</div>
        </div>`).join('');
      }

      /********************
       *  CIRCLES render helpers (depend on t, circleList)
       ********************/
      function renderCircles(){
        circleList.innerHTML = circles.map(c=>`
          <div class="tile row">
            <div>
              <b>${c.nameKey ? t(c.nameKey) : c.name}</b>
              <div class="muted">${c.members} ${t('circle.members')}</div>
            </div>
            <button class="btn equal" data-open="${c.id}">${t('circle.open')}</button>
          </div>`).join('');

        circleList.querySelectorAll('[data-open]').forEach(btn=>{
          btn.addEventListener('click',()=> showCircle(Number(btn.getAttribute('data-open'))));
        });
      }


      /********************
       *  applyLang AFTER renderers exist
       ********************/
      async function applyLang(code){
          const dict = i18n[code]||i18n.uk;
          document.querySelectorAll('[data-i18n]').forEach(el=>{
            const k = el.getAttribute('data-i18n');
            if(dict[k]) el.textContent = dict[k];
          });
          localStorage.setItem('sc_lang', code);
          // Update dynamic bits
          weatherCityEl.textContent = t('weather.city.'+weather.cityKey);
          if (weatherBox.firstChild) weatherBox.firstChild.textContent = `üå°Ô∏è ${weather.tempC}¬∞ ‚Ä¢ ${weather.icon} `;
          renderFeed();
          renderCircles();
          await saveState({ lang: code });
        }


      /********************
       *  THEME selector (dark/midnight/light)
       ********************/
      const themeSel = document.getElementById('themeSel');
        async function applyTheme(theme){
          document.body.setAttribute('data-theme', theme);
          localStorage.setItem('sc_theme', theme);
          await saveState({ theme: theme });
        }
        const savedTheme = state.theme || localStorage.getItem('sc_theme') || 'dark';
        await applyTheme(savedTheme);
        themeSel.value = savedTheme;
        themeSel.addEventListener('change', async () => { await applyTheme(themeSel.value); if(tg && tg.HapticFeedback && tg.HapticFeedback.selectionChanged) try{ tg.HapticFeedback.selectionChanged(); }catch(e){} });

      // ‚Üê –í–°–¢–ê–í–¨ –ó–î–ï–°–¨ 
      initTelegram(); 
      
      // === Telegram auth (robust) ===
      async function tryTelegramAuth() {
        if (!tg || accessToken) return;

        const init_str = (typeof tg.initData === 'string' ? tg.initData : '') || '';
        const init_obj = tg.initDataUnsafe || null;

        // –µ—Å–ª–∏ –Ω–µ –≤ Telegram ‚Äî –≤—ã—Ö–æ–¥–∏–º
        if (!init_str && !init_obj) return;

        try {
          const res = await fetch(API_BASE + '/verify-telegram', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ init_data: init_str, init_obj })
          });
          if (res.ok) {
            const { access } = await res.json();
            accessToken = access;
            localStorage.setItem('sc_access_token', accessToken);
            await renderDiag({ note: 'tg auth ok' });
            await syncFromServer();
          } else {
            const err = await res.json().catch(()=>({}));
            console.warn('tg auth fail', err);
            await renderDiag({ note: 'tg auth fail' });
          }
        } catch (e) {
          console.warn('tg auth error', e);
          await renderDiag({ note: 'tg auth error' });
        }
      }

      await tryTelegramAuth();


      // –ø—Ä—è—á–µ–º Dev login, –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –≤–Ω—É—Ç—Ä–∏ Telegram
      const devBtn = document.getElementById('btnDevLogin');
      if (tg && devBtn) devBtn.style.display = 'none';

      // [E5] –ø–æ–∫–∞–∑–∞—Ç—å/—Å–º–µ–Ω–∏—Ç—å API BASE
      const apiBaseShow = document.getElementById('apiBaseShow');
      if (apiBaseShow) apiBaseShow.textContent = API_BASE || '(–Ω–µ –∑–∞–¥–∞–Ω)';
      const setApiBaseBtn = document.getElementById('setApiBaseBtn');
      if (setApiBaseBtn) setApiBaseBtn.onclick = () => {
        const u = prompt('API base URL[](https://‚Ä¶):', API_BASE || 'https://safeconnect-api-dev.spacewenderer1.workers.dev');
        if (u != null) setApiBase(u.trim());
      };
      
      // === Diagnostics ===
      const diagBox = document.getElementById('diagBox');

      async function whoAmI() {
        if (!accessToken) return null;
        try {
          return await apiFetch('/authed/me');
        } catch (e) {
          return { error: String(e) };
        }
      }

      function short(str, n=14) {
        if (!str) return '';
        return str.length > n ? (str.slice(0,n) + '‚Ä¶') : str;
      }

      async function renderDiag(extra={}) {
        const inTg = !!tg;
        const hasInitStr = inTg && typeof tg.initData === 'string' && tg.initData.length > 0;
        const hasInitObj = inTg && tg.initDataUnsafe && typeof tg.initDataUnsafe === 'object';
        let me = await whoAmI();
        const lines = [
          `TG: ${inTg ? 'yes' : 'no'} | init_data: ${hasInitStr?'str':'‚Äî'} | init_obj: ${hasInitObj?'obj':'‚Äî'}`,
          `API: ${API_BASE}`,
          `Token: ${accessToken ? 'set ' + short(accessToken, 18) : '‚Äî'}`,
          me && !me.error ? `Me: id=${me.id||'‚Äî'} pro=${me.pro?.status||'none'}` : `Me: ‚Äî${me&&me.error?(' ('+me.error+')'):''}`,
          extra.note ? `Note: ${extra.note}` : ''
        ].filter(Boolean);
        if (diagBox) diagBox.textContent = lines.join(' | ');
      }

      // –ö–Ω–æ–ø–∫–∏ ‚ÄúAuth test‚Äù –∏ ‚ÄúClear token‚Äù
      const btnAuthTest = document.getElementById('btnAuthTest');
      if (btnAuthTest) btnAuthTest.onclick = async () => {
        await renderDiag({ note: 'auth test clicked' });
      };

      const btnClearToken = document.getElementById('btnClearToken');
      if (btnClearToken) btnClearToken.onclick = async () => {
        accessToken = null;
        localStorage.removeItem('sc_access_token');
        await renderDiag({ note: 'token cleared' });
      };

      // –ü–µ—Ä–≤–∏—á–Ω—ã–π –≤—ã–≤–æ–¥
      renderDiag();

      // [E5] dev login ‚Üí –∑–∞–ø—Ä–æ—Å–∏—Ç—å —É API access —Ç–æ–∫–µ–Ω
      if (devBtn) devBtn.onclick = async () => {
        if (!API_BASE) { alert('–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏ API URL'); return; }
        try {
          const dev_secret = prompt('DEV_LOGIN_SECRET (–∫–∞–∫ –≤ wrangler.toml –∏–ª–∏ Dashboard):', '');
          const res = await apiFetch('/verify', {
            method: 'POST',
            body: JSON.stringify({ dev_secret, dev_user: 'me' })
          });
          accessToken = res.access;
          localStorage.setItem('sc_access_token', accessToken);
          alert('Dev login OK');
          await syncFromServer();
        } catch (e) { console.error(e); alert('Login failed'); }
      };
      
      /********************
       *  Circles controls
       ********************/
      document.getElementById('btnAddCircle').onclick = async () => {
        if (circles.length >= FREE_LIMITS.circles) { openProModal(); return; }
        const nm = prompt('–ù–∞–∑–≤–∞ –∫–æ–ª–∞', 'New circle');
        if (!nm) return;
        const cir = await createCircle(nm);
        circles.push(cir);
        await saveState({ circles });
        renderCircles();
      };

      document.getElementById('btnSOS').onclick = () => alert('SOS scripts in Pro (mock)');
      document.getElementById('btnCheckIn').onclick = () => alert('Sent: "I\'m safe"');
      document.getElementById('btnBroadcast').onclick = () => alert('Broadcast to all circles (Pro)');
      const circleModal = document.getElementById('circleModal');
      const circleTitle = document.getElementById('circleTitle');
      const memberList = document.getElementById('memberList');
      document.getElementById('circleClose').onclick = () => circleModal.classList.remove('show');
      document.getElementById('circleEdit').onclick = () => alert('–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —Ä–æ–ª–µ–π –±—É–¥–µ –Ω–∞ –ï—Ç–∞–ø—ñ 3‚Äì4');

      function showCircle(id) {
        const c = circles.find(x => x.id === id);
        if (!c) return;
        circleTitle.textContent = c.name || '–ö–æ–ª–æ';
        memberList.innerHTML = `
          <div class="tile row">
            <div>
              <b>–í–ª–∞—Å–Ω–∏–∫</b>
              <div class="muted">1 ${t('circle.members')}</div>
            </div>
            <span class="muted">Owner</span>
          </div>
          <div class="tile row">
            <div>
              <b>–£—á–∞—Å–Ω–∏–∫</b>
              <div class="muted">1 ${t('circle.members')}</div>
            </div>
            <span class="muted">Member</span>
          </div>
        `;
        circleModal.classList.add('show');

        // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è
        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = '–í–∏–¥–∞–ª–∏—Ç–∏ –∫–æ–ª–æ';
        deleteBtn.className = 'btn';
        deleteBtn.onclick = async () => {
          if (confirm(`–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ –∫–æ–ª–æ "${c.name}"?`)) {
            await deleteCircle(c.id);
            circles = circles.filter(x => x.id !== c.id);
            await saveState({ circles });
            renderCircles();
            circleModal.classList.remove('show');
          }
        };
        memberList.appendChild(deleteBtn);
      }

      // [E5] helpers
      function apiReady() { return !!API_BASE && !!accessToken; }

      async function syncFromServer() {
        if (!apiReady()) return;
        try {
          const srvCircles = await apiFetch('/authed/circles');
          circles = srvCircles.map(c => ({ id: c.id, name: c.name, members: 1 }));
          await saveState({ circles });
          renderCircles();
          await renderDiag({ note: 'synced' });
        } catch (e) {
          console.warn('syncFromServer fail', e);
          await renderDiag({ note: 'sync error' });
        }
      }


      async function createCircle(name) {
        if (apiReady()) {
          const r = await apiFetch('/authed/circles', { method: 'POST', body: JSON.stringify({ name }) });
          return { id: r.id, name: r.name, members: 1 };
        } else {
          return { id: Date.now(), name, members: 1 };
        }
      }

      async function deleteCircle(id) {
        if (!apiReady()) return;
        // –ú–∏–Ω–∏-–ø—Ä–æ–≤–µ—Ä–∫–∞ UUID (–±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ –ë–î —É –Ω–∞—Å –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–∏–µ id)
        const uuidLike = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(String(id));
        if (!uuidLike) { console.warn('skip delete: local/offline id', id); return; }
        try { await apiFetch('/authed/circles/' + id, { method: 'DELETE' }); } catch (e) { console.warn(e); }
      }

      /********************
       *  Validation helpers
       ********************/
      function sanitizeText(s, max=400) {
        return String(s||'').replace(/[\u0000-\u001F]+/g,' ').trim().slice(0,max);
      }
      function isBloodType(s) {
        // –¥–æ–ø—É—Å–∫–∞–µ–º: 0(I)/A(II)/B(III)/AB(IV) —Å Rh+/-
        const v = String(s||'').trim().toUpperCase();
        const patt = /^(0|A|B|AB)\s*(\((I{1,3}|IV|V)\))?\s*RH[+-]?$/; // ¬´0(I) Rh+¬ª –∏ –±–ª–∏–∑–∫–∏–µ
        const alt  = /^(0|A|B|AB)\s*[^a-zA-Z0-9]*\s*R(H)?[+-]$/;       // –ª–æ—è–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
        return patt.test(v) || alt.test(v);
      }

      /********************
       *  ICE inputs & meds (persist)
       ********************/
      document.getElementById('iceAllergies').addEventListener('input', async (e)=>{
        state.ice.allergies = sanitizeText(e.target.value, 2000);
        await saveState({ ice: { allergies: state.ice.allergies } });
        await persistICEIfProtected();
      });

      document.getElementById('iceBlood').addEventListener('input', async (e)=>{
        const val = sanitizeText(e.target.value, 32);
        state.ice.blood = val;
        const el = e.target;
        el.style.borderColor = isBloodType(val) ? 'var(--line)' : 'var(--danger)';
        await saveState({ ice: { blood: state.ice.blood } });
        await persistICEIfProtected();
      });

      const critListEl = document.getElementById('critList');
      const secListEl  = document.getElementById('secList');

      /* PATCH 2B: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ/—É–¥–∞–ª–µ–Ω–∏–µ –ø–æ –∫–ª–∏–∫—É –Ω–∞ ‚úé/√ó */
      document.getElementById('screen-ice-meds').addEventListener('click', async (e)=>{
        const row = e.target.closest('.tile[data-kind]');
        if(!row) return;
        const kind = row.dataset.kind;
        const idx  = Number(row.dataset.idx);

        if(e.target.closest('[data-edit]')){
          const cur = kind==='crit' ? state.ice.medsCrit[idx] : state.ice.medsSec[idx];
          const next = sanitizeText(prompt(t(kind==='crit'?'ice.meds.critical':'ice.meds.secondary'), cur) || cur, 120);
          if(!next || next===cur) return;
          if(kind==='crit') state.ice.medsCrit[idx]=next; else state.ice.medsSec[idx]=next;
          await saveState({ ice:{ medsCrit: state.ice.medsCrit, medsSec: state.ice.medsSec }});
          await persistICEIfProtected();
          renderMedsLists();
        }

        if(e.target.closest('[data-del]')){
          if(!confirm(t('common.back')==='Back'?'Delete item?':'–í–∏–¥–∞–ª–∏—Ç–∏ –µ–ª–µ–º–µ–Ω—Ç?')) return;
          if(kind==='crit') state.ice.medsCrit.splice(idx,1); else state.ice.medsSec.splice(idx,1);
          await saveState({ ice:{ medsCrit: state.ice.medsCrit, medsSec: state.ice.medsSec }});
          await persistICEIfProtected();
          renderMedsLists();
        }
      });

      document.getElementById('addCrit').onclick = async ()=>{
        const name = sanitizeText(prompt(t('ice.meds.critical')) || '', 120);
        if(!name) return;
        state.ice.medsCrit.push(name);
        await saveState({ ice: { medsCrit: state.ice.medsCrit } });
        await persistICEIfProtected();
        renderMedsLists(); // PATCH 2A: –ò—Å–ø–æ–ª—å–∑—É–µ–º renderMedsLists –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
      };

      document.getElementById('addSec').onclick = async ()=>{
        const name = sanitizeText(prompt(t('ice.meds.secondary')) || '', 120);
        if(!name) return;
        state.ice.medsSec.push(name);
        await saveState({ ice: { medsSec: state.ice.medsSec } });
        await persistICEIfProtected();
        renderMedsLists(); // PATCH 2A: –ò—Å–ø–æ–ª—å–∑—É–µ–º renderMedsLists –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞
      };

      /* PATCH 2A: –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–Ω–¥–µ—Ä —Å –∫–Ω–æ–ø–∫–∞–º–∏ ‚úé –∏ √ó */
      function renderMedsLists(){
        const rowHTML = (name, kind, idx) => `
          <div class="tile row" data-kind="${kind}" data-idx="${idx}">
            <div class="med-text" style="word-break:break-word">${name}</div>
            <div style="display:flex;gap:6px">
              <button class="btn mini" data-edit>‚úé</button>
              <button class="btn mini danger" data-del>√ó</button>
            </div>
          </div>`;
        critListEl.innerHTML = state.ice.medsCrit.map((n,i)=>rowHTML(n,'crit',i)).join('');
        secListEl.innerHTML  = state.ice.medsSec.map((n,i)=>rowHTML(n,'sec',i)).join('');
      }

      document.querySelector('[data-ice="meds"]').addEventListener('click', renderMedsLists);



      /********************
       *  ICE docs chips (add/remove with confirm)
       ********************/
      function renderDocs(){
        const filled = docs.map((d,i)=>`<div class="chip filled" data-idx="${i}" title="Click to remove">${d.icon||'üìÑ'}</div>`);
        const freeSlots = Math.max(0, FREE_LIMITS.docs - docs.length);
        const empty = Array.from({length: freeSlots},()=>`<div class="chip" data-add="1">Ôºã</div>`);
        docChips.innerHTML = [...filled, ...empty].join('');
      }
      renderDocs();
      docChips.addEventListener('click', async (e)=>{
        const add = e.target.closest('[data-add]');
        const filled = e.target.closest('.filled');
        if(add){
          if(docs.length >= FREE_LIMITS.docs){ openProModal(); return; }
          docs.push({icon:'ü™™'});
          await saveState({ docs });
          renderDocs(); return;
        }
        if(filled){
          const idx = Number(filled.getAttribute('data-idx'));
          if(Number.isInteger(idx)){
            if(confirm(t('common.back')==='Back'?'Remove document?':'–í–∏–¥–∞–ª–∏—Ç–∏ –¥–æ–∫—É–º–µ–Ω—Ç?')){
              docs.splice(idx,1);
              await saveState({ docs });
              renderDocs();
            }
          }
        }
      });


      /********************
       *  Settings ‚Üí Pro
       ********************/
      document.getElementById('btnPro').onclick = ()=>go('pro');
      document.getElementById('btnBuy').onclick = ()=>alert('Payments via Telegram (mock)');
      document.getElementById('btnTry').onclick = ()=>alert('7-day Pro trial activated (mock)');

      /********************
       *  Pro modal (upsell)
       ********************/
      const proModal = document.getElementById('proModal');
      function openProModal(){ proModal.classList.add('show'); }
      document.getElementById('proClose').onclick = ()=>proModal.classList.remove('show');
      document.getElementById('proBuyNow').onclick = ()=>{ proModal.classList.remove('show'); go('pro'); };

      /********************
       *  Filters modal (placeholder)
       ********************/
      const filtersModal = document.getElementById('filtersModal');
      document.getElementById('btnFilters').onclick = ()=>filtersModal.classList.add('show');
      document.getElementById('filtersCancel').onclick = ()=>filtersModal.classList.remove('show');
      document.getElementById('filtersApply').onclick = ()=>{ filtersModal.classList.remove('show'); alert('Filters applied (mock)'); };

      // PIN buttons
      document.getElementById('btnSetPIN').onclick = setPIN;
      document.getElementById('btnUnlock').onclick = unlockICE;
      document.getElementById('btnLock').onclick = lockICE;

      // –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
      const iceLockHint = document.getElementById('iceLockHint');
      function renderICEStatus(){
        iceLockHint.textContent = state.iceLocked ? 'ICE –∑–∞–±–ª–æ–∫–æ–≤–∞–Ω–æ. –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å üîì —â–æ–± —Ä–æ–∑–±–ª–æ–∫—É–≤–∞—Ç–∏.' : '';
      }
      renderICEStatus();


      /********************
       *  TESTS ‚Äî existing + added
       ********************/
      console.assert(typeof levelBadge('warn')==='string', 'levelBadge must return HTML string');
      console.assert(feedData.length===3, 'feedData length should be 3');
      // NEW: feedList exists & render produces same count as feedData
      console.assert(!!feedList, 'feedList element should exist');
      renderFeed();
      console.assert(feedList.querySelectorAll('.tile').length===feedData.length, 'renderFeed should render all items');
      // NEW: language toggling updates nav label
      console.assert((()=>{applyLang('ru'); const ok=document.querySelector('[data-i18n="nav.settings"]').textContent==='–ù–∞—Å—Ç—Ä.'; applyLang('uk'); return ok; })(), 'i18n should switch nav labels');
      // Existing docs test (kept)
      console.assert((()=>{const prev=docs.length; docs.push({icon:'üìÑ'}); renderDocs(); const ok=docChips.querySelectorAll('.filled').length===docs.length; docs.pop(); renderDocs(); return ok;})(), 'docs rendering count matches state');
      // NEW: theme variable application test
      console.assert((()=>{applyTheme('light'); const a=getComputedStyle(document.body).getPropertyValue('--bg'); applyTheme('dark'); return !!a;})(), 'theme variables apply');
      // DB basic roundtrip
      console.assert((await DB.set('test_key', {x:1}))===undefined || true, 'DB.set works');
      console.assert(((await DB.get('test_key'))||{}).x===1, 'DB.get works');
      // state save/restore
      const prevLang = state.lang;
      await saveState({ lang: 'en' });
      const tmp = await DB.get('state');
      console.assert(tmp && tmp.lang==='en', 'state saved lang=en');
      await saveState({ lang: prevLang });
    });
  </script>

  <!-- PWA: register Service Worker -->
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('sw.js')
    }
  </script>
</body>
</html>
